<plex-layout main="9">
    <plex-layout-main>
        <!--ENCABEZADO-->
        <header *ngIf='modo && modo.id !=="recepcion"'>
            <h4>Laboratorio general | Practicas y resultados</h4>
        </header>
        <header *ngIf='modo && modo.id ==="recepcion"'>
            <div class="page-title">NUEVA SOLICITUD</div>
        </header>

        <!--SECCION PACIENTE-->
        <div class="row" *ngIf="seleccionPaciente" style="display: block">
            <div class="col-12">
                <label>Paciente</label>
                <pacientesSearch [bloquearCreate]="true" [modoCompleto]="false" [hideFooter]="true" (selected)="seleccionarPaciente($event)">
                </pacientesSearch>
            </div>
        </div>
        <span *ngIf='modo.id !=="recepcion"' class="badge badge-success" style='float: left; margin-right: 20px;'>
            <h2>{{modelo.solicitud.registros[0].valor.solicitudPrestacion.numeroProtocolo?.numeroCompleto}}</h2>
        </span>
        <ng-container *ngIf="!seleccionPaciente">
            <div class="row">
                <div class="col-12">
                    <h2>{{modelo.paciente.documento}} - {{modelo.paciente.apellido}}, {{modelo.paciente.nombre}}</h2>
                </div>
            </div>
            <div class="row">
                <div class="col-10">
                    F. Nac.: {{modelo.paciente.fechaNacimiento | date: 'dd/MM/yyyy' }}, Sexo: {{modelo.paciente.sexo}}
                </div>
                <div class="col-2">
                    <plex-button position="left" type="warning" *ngIf='modo.id ==="control"' (click)="cambiarPaciente()">Cambiar Paciente</plex-button>
                </div>
            </div>
            <br>
        </ng-container>
        <!--FIN SECCION PACIENTE-->

        <!-- SECCION PROTOCOLO -->
        <ng-container *ngIf="showProtocoloDetalle">
            <!-- ENCABEZADO DE PROTOCOLO -->
            <section class="labs-listado-item">
                <plex-button *ngIf='modo.id !=="recepcion"' type="info" icon="chevron-left" (click)='anterior()' style='margin-right: 10px;'></plex-button>
                <div class="listado-contenedor-secundario">
                    <article *ngIf='modo.id !=="recepcion" && modo.id !=="control"' class="labs-item-numero">
                        <div class="row">
                            <div class="col-3">
                                <strong>Fecha de solicitud: </strong>
                                <p>{{ modelo.solicitud.fecha | date: 'dd/MM/yyyy' }}</p>
                            </div>
                            <div class="col-3">
                                <strong>Fecha de toma de muestra: </strong>
                                <p>{{modelo.solicitud.registros[0].valor.solicitudPrestacion.fechaTomaMuestra | date: 'dd/MM/yyyy'
                                    }}
                                </p>
                            </div>
                            <div class="col-3">
                                <strong>Origen: </strong>
                                <p>{{ modelo.solicitud.ambitoOrigen}}</p>
                            </div>
                            <div class="col-3">
                                <strong>Servicio: </strong>
                                <p>{{modelo.solicitud.registros[0]?.valor?.solicitudPrestacion?.servicio.term}}</p>
                            </div>
                            <div class="col-3">
                                <strong>Usuario:&nbsp;</strong>
                                <p>{{ modelo.createdBy.nombreCompleto }}</p>
                            </div>
                            <div class="col-3">
                                <strong>Fecha de Ejecucion:&nbsp;</strong>
                                <p>{{ modelo.ejecucion.fecha | date: 'dd/MM/yyyy' }}</p>
                            </div>
                            <div class="col-3">
                                <strong>Profesional Solicitante: </strong>
                                <p>{{ modelo.solicitud.profesional.nombre }} {{ modelo.solicitud.profesional.apellido }}</p>
                            </div>
                            <div class="col-3">
                                <strong>Efector Solicitante: </strong>
                                <p>{{ modelo.solicitud.organizacion.nombre }}</p>
                            </div>
                            <div class="col-3">
                                <strong>Diagnostico: </strong>
                                <p>{{ modelo.solicitud.registros[0]?.valor?.solicitudPrestacion.diagnostico }}</p>
                            </div>
                        </div>
                    </article>
                    <article *ngIf='modo.id ==="recepcion" || modo.id ==="control"' class="labs-item-numero">
                        <div class="row">
                            <div class="col-3">
                                <plex-datetime type="date" [(ngModel)]="modelo.ejecucion.fecha" name="fecha" label="Fecha Actual" [required]="true"></plex-datetime>
                            </div>
                            <div class="col-3">
                                <plex-datetime type="date" [(ngModel)]="modelo.solicitud.registros[0].valor.solicitudPrestacion.fechaTomaMuestra" name="fechaTomaMuestra"
                                    label="Fecha toma de muestra" [required]="true"></plex-datetime>
                            </div>

                            <div class="col-3">
                                <plex-datetime type="date" [(ngModel)]="modelo.solicitud.fecha" name="fecha" label="Fecha de solicitud" [required]="true"></plex-datetime>
                            </div>
                            <div class="col-3">
                                <!-- TODO: Una vez implementado TOP cambiar modelo.solicitud.organizacion x modelo.solicitud.organizacionOrigen -->
                                <plex-select [(ngModel)]="modelo.solicitud.organizacion" [data]="organizacion" labelField="nombre" placeholder="Seleccione..."
                                    label="Efector Solicitante" [required]="true">
                                </plex-select>
                            </div>
                            <div class="col-3">
                                <!-- TODO: Una vez implementado TOP cambiar modelo.solicitud.profesional x modelo.solicitud.profesionalOrigen -->
                                <plex-select [(ngModel)]="modelo.solicitud.profesional" name="profesional" label="Profesional solicitante" (getData)="loadProfesionales($event)"
                                    placeholder="Escriba el apellido del Profesional" labelField="apellido + ' ' + nombre" [required]="true">
                                </plex-select>
                            </div>
                            <div class="col-3">
                                <plex-select [(ngModel)]="modelo.solicitud.registros[0].valor.solicitudPrestacion.prioridad" name="prioridad" (getData)="loadPrioridad($event)"
                                    label="Prioridad" placeholder="Seleccione la prioridad" labelField="nombre" [required]="true">
                                </plex-select>
                            </div>
                            <div class="col-3">
                                <plex-select [(ngModel)]="modelo.solicitud.ambitoOrigen" name="ambitoOrigen" (getData)="loadOrigen($event)" label="Origen"
                                    placeholder="Seleccione el origen" [required]="true">
                                </plex-select>

                            </div>
                            <div class="col-3">
                                <plex-select [(ngModel)]="modelo.solicitud.registros[0].valor.solicitudPrestacion.servicio" label="Servicio" placeholder="Seleccione el servicio"
                                    (getData)="loadServicios($event)" labelField='term'>
                                </plex-select>
                            </div>
                            <div class="col-3">
                                <plex-select [(ngModel)]="modelo.solicitud.registros[0].valor.solicitudPrestacion.area" name="laboratorioInterno" label="Area"
                                    (getData)="loadArea($event)" [required]="true"></plex-select>
                            </div>
                        </div>
                    </article>
                </div>
                <div *ngIf='modo.id !=="recepcion" && modo.id !=="control"' class="badge-container">
                    <plex-badge type="danger" class="ml-2"> {{modelo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre}} </plex-badge>
                    <plex-badge type="warning" class="ml-2"> {{modelo.estados[0].tipo}} </plex-badge>
                </div>
                <plex-button *ngIf='modo.id !=="recepcion"' type="info" icon='chevron-right' (click)='siguiente()' style='margin-left: 10px;'></plex-button>

            </section>
            <!-- FIN ENCABEZADO DE PROTOCOLO -->
            <hr>
            <!-- BUSCADOR DE PRACTICAS -->
            <plex-tabs>
                <plex-tab label="Analisis">

                    <div class="row" *ngIf="(modo.id === 'recepcion') || modo.id === 'control'">
                        <div class="col-12">
                            <label>Practicas</label>
                            <practica-buscar (busquedaInicial)="busquedaInicial()" (busquedaFinal)="busquedaFinal($event)" (searchClear)="searchClear()">
                            </practica-buscar>
                        </div>
                        <practica-listado *ngIf="practicas && practicas.length" [practicas]="practicas" [autoselect]="false" (selected)="seleccionarPractica($event)"></practica-listado>
                        <div *ngIf="practicas && !practicas.length" class="alert alert-default">
                            ¡No se encontró ningúna practica!
                        </div>
                    </div>
                    <!-- FIN BUSCADOR DE PRACTICAS -->

                    <!-- TABLA VISUALIZACION DE PRACTICAS -->
                    <hr>
                    <div class="row">
                        <div class="col">
                            <table *ngIf="modelo.ejecucion?.registros.length> 0" class="table table-striped table-sm">
                                <thead>
                                    <th>Cod.</th>
                                    <th>Descripcion</th>
                                    <th *ngIf='modo.id ==="recepcion" || modo.id ==="control"' class="float-center">S/Muestra</th>
                                    <ng-container *ngIf='modo.id !=="control" && modo.id !=="recepcion"'>
                                        <th class="float-center">Valor</th>
                                        <th *ngIf='modo.id ==="validacion"' class="float-center">R. Anterior</th>
                                        <th class="float-center">UM</th>
                                        <th class="float-center">VR</th>
                                    </ng-container>
                                    <ng-container *ngIf='modo.id ==="validacion"'>
                                        <th class="float-center">
                                            <div>
                                                <plex-bool type="checkbox" [(ngModel)]="flagMarcarTodas" (change)="validarTodas($event)" name="validarTodos"></plex-bool>
                                            </div>Validar </th>
                                    </ng-container>
                                    <th></th>
                                    <th *ngIf='modo.id ==="recepcion" || modo.id ==="control"'>Acciones</th>
                                    <th *ngIf='modo.id ==="carga" || modo.id ==="validacion"'>Observaciones</th>
                                </thead>
                                <tbody>
                                    <tr class="hover" *ngFor="let practica of modelo.ejecucion.registros[0].valor">
                                        <td>{{practica.codigo}}</td>
                                        <td>{{practica.nombre}}</td>
                                        <ng-container *ngIf='modo.id ==="recepcion" || modo.id ==="control"'>
                                            <plex-bool type="checkbox" [(ngModel)]="practica.resultado.sinMuestra" name="sinMuestra"></plex-bool>
                                        </ng-container>
                                        <ng-container *ngIf='modo.id !=="control"&& modo.id !=="recepcion"'>
                                            <td class="text-left align-middle estado">
                                                <p>
                                                    <plex-float *ngIf="!practica.resultado.sinMuestra" [(ngModel)]="practica.resultado.valor"></plex-float>
                                                    <b *ngIf="practica.resultado.sinMuestra"> Sin muestra</b>
                                                </p>
                                            </td>

                                            <td *ngIf='modo.id ==="validacion"'>
                                                <span style='color:green'>
                                                    {{practica.resultado?.resultadosAnteriores[(practica.resultado.resultadosAnteriores.length) - 1]?.valor}}
                                                    <br> {{practica.resultado?.resultadosAnteriores[(practica.resultado.resultadosAnteriores.length)
                                                    - 1]?.unidadMedida}}
                                                    <br> {{practica.resultado?.resultadosAnteriores[(practica.resultado.resultadosAnteriores.length)
                                                    - 1]?.fecha | date: 'dd/MM/yyyy' }}
                                                </span>
                                            </td>
                                            <td>
                                                {{practica.unidadMedida.nombre}}
                                            </td>
                                            <td>
                                                {{practica.metodo.valoresReferencia.valorMinimo}} - {{practica.metodo.valoresReferencia.valorMaximo}}
                                            </td>
                                        </ng-container>
                                        <ng-container *ngIf='modo.id ==="validacion"'>
                                            <td>
                                                <plex-bool type="checkbox" [(ngModel)]="practica.resultado.validado" name="validado" (change)="clickValidar($event)" name="clickValidar"></plex-bool>
                                            </td>
                                        </ng-container>
                                        <td></td>
                                        <ng-container *ngIf='modo.id ==="recepcion" || modo.id ==="control"'>
                                            <td>
                                                <plex-button label="" type="danger btn-sm" icon="delete" (click)="eliminarPractica(practica)"></plex-button>
                                            </td>
                                        </ng-container>
                                        <ng-container *ngIf='(modo.id ==="carga" || modo.id ==="validacion") && !showObservaciones'>
                                            <td>
                                                <plex-button type="info" title="Observaciones" icon="mdi mdi-file-document" (click)="verObservaciones()">
                                                </plex-button>
                                            </td>
                                        </ng-container>
                                        <div class="row">
                                            <div class="col-12">
                                                <plex-text *ngIf=" showObservaciones" name="observaciones" [(ngModel)]="practica.observaciones">
                                                </plex-text>
                                            </div>

                                            <div *ngIf="showObservaciones" class="col-1 btnEdit">
                                                <plex-button type="danger" icon="close-circle-outline" title="Guardar" (click)="cerrarObservacion()">
                                                </plex-button>
                                            </div>

                                        </div>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- FIN TABLA VISUALIZACION DE PRACTICAS -->
                    <hr>
                </plex-tab>
                <plex-tab *ngIf='modo.id ==="recepcion" || modo.id ==="control"' label="Diagnostico">
                    <div class="row">
                        <div class="col-12">
                            <plex-text [(ngModel)]="modelo.solicitud.registros[0].valor.solicitudPrestacion.diagnostico" label="Diagnostico" name="diagnostico"
                                multiline="true">
                            </plex-text>
                        </div>
                    </div>
                </plex-tab>
                <plex-tab label="Incidencias"></plex-tab>
            </plex-tabs>
            <!--OBSERVACIONES - RECEPCION-->
            <div class="row">
                <div *ngIf="modo.id==='recepcion' || modo.id==='control' || modo.id==='carga'" class="col-12">
                    <plex-text [(ngModel)]="modelo.solicitud.registros[0].valor.solicitudPrestacion.observaciones" label="Observaciones" name="observaciones"
                        multiline="true">
                    </plex-text>
                </div>
                <div *ngIf="modo.id==='validacion'" class="col-12">
                    <b> {{modelo.solicitud.registros[0].valor.solicitudPrestacion.observaciones}} </b>
                </div>
            </div>
        </ng-container>
        <!--FIN SECCION PRTOCOLO -->

        <!-- Botonera 
        <div class="botonera-container" *ngIf='modo.id !=="recepcion"'>
            <plex-button class="left ml-2" type="info" icon='chevron-up' label="boton clave 1"></plex-button>
            <plex-button class="center ml-2" type="success" icon='chevron-up' label="boton clave 2"></plex-button>
            <plex-button class="right ml-2" type="warning" icon='chevron-up' label="boton clave 3"></plex-button>
        </div>
        <hr>    -->




    </plex-layout-main>
    <plex-layout-sidebar *ngIf='modo.id !=="recepcion"'>
        <div class="row" *ngFor="let protocolo of protocolos; let i=index" (click)='modelo = protocolo; indexProtocolo = i' [ngClass]="{'invert': protocolo._id === modelo._id}">
            <div class="col-2">
                <i *ngIf='protocolo.paciente.sexo ==="femenino"' class="mdi mdi-gender-female mdi-36px mdi-rotate-45 rosa"></i>
                <i *ngIf='protocolo.paciente.sexo ==="masculino"' class="mdi mdi-gender-male mdi-36px  azul"></i>
            </div>
            <div class="col-5">
                <label class="control-label text-info">N° Protocolo</label>
                <span>{{protocolo.solicitud.registros[0].valor.solicitudPrestacion.numeroProtocolo?.numeroCompleto}}</span>
            </div>
            <div class="col-5">
                <label class="control-label text-info">Fecha</label>
                <span>{{protocolo.solicitud.fecha | date: 'dd/MM/yyyy'}}</span>
            </div>
            <hr>
        </div>
    </plex-layout-sidebar>

    <plex-layout-footer>
        <plex-button position="left" type="warning" (click)="volverProtocolos()">Volver</plex-button>
        <plex-button *ngIf='modo.id !=="validacion" && !seleccionPaciente' position="right" class="float-right mr-1" type="success"
            label="Guardar" (click)="guardarSolicitud($event)"></plex-button>
        <plex-button *ngIf='modo.id ==="validacion"' position="right" class="float-right mr-1" type="success" label="Validar todos"
            (click)="guardarSolicitud($event)"></plex-button>
        <plex-button *ngIf='modo.id ==="validacion"' position="right" class="float-right mr-1" type="success" label="Validar pendientes"
            (click)="guardarSolicitud($event)"></plex-button>

    </plex-layout-footer>
</plex-layout>