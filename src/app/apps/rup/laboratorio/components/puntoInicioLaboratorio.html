<plex-layout main="12" *ngIf="showListarProtocolos">
    <plex-layout-main>
        <!-- ENCABEZADO -->
        <header>
            <h4>Punto de inicio | Laboratorio</h4>
            <section class="contenedor-tabs">
                <plex-tabs>
                    <plex-tab label="Laboratorio general"></plex-tab>
                    <plex-tab label="Microbiologia"></plex-tab>
                    <plex-tab label="Screening neonatal"></plex-tab>
                </plex-tabs>
                <!-- <plex-tabs [activeIndex]="modo">
                    <plex-tab label="Control" (click)="console.log('control') "><a href="javascript:console.log('x')"></a></plex-tab>
                    <plex-tab label="Carga" (click)="modo.id = 'carga'"></plex-tab>
                    <plex-tab label="Validación" (click)="modo.id = 'validacion'"></plex-tab>
                </plex-tabs> -->
                <div class="dropdown-secundario">
                    <i class="mdi mdi-dots-horizontal"></i>
                </div>
            </section>
        </header>
        <!-- FIN ENCABEZADO -->
        <!-- 
        <div class="row">
            <div class="col">
                <plex-button type="success" size="sm" name="especialidad.activo" label='Recordar filtros' position="right" style="float: right"
                    (click)='recordarFiltros()'></plex-button>
            </div>
        </div>
     -->
        <div class="row">
            <div class="col-2">
                <plex-select [(ngModel)]="modo" name="area" label="Modo" [data]='cargaLaboratorioEnum' [required]="true"></plex-select>
            </div>
            <div class="col-3" *ngIf='(modo.id === "carga" || modo.id === "validacion")'>
                <plex-select [(ngModel)]="formaCarga" name="formaCarga" label="Forma de carga" (change)="refreshSelection($event,'area')"
                    [data]='modoCargaLaboratorioEnum' [required]="true"></plex-select>
            </div>
            <div class="col-3" *ngIf='(modo.id ==="carga" || modo.id ==="validacion")'>
                <plex-select [(ngModel)]="estado" (change)="refreshSelection($event,'estado')" name="estado" label="Estado" [data]="estadosValFiltroEnum"></plex-select>
            </div>
        </div>

        <div class="row contenedor-filtros">
            <div class="col-2">
                <plex-select [(ngModel)]="area" (change)="refreshSelection($event,'area')" name="area" label="Area" [data]='laboratorioInternoEnum'></plex-select>
            </div>
            <div *ngIf='modo.id !== "recepcion"' class="col-2">
                <plex-select [(ngModel)]="prioridad" (change)="refreshSelection($event,'prioridad')" name="prioridad" label="Prioridad" [data]="prioridadesFiltroEnum"></plex-select>
            </div>
            <div *ngIf='modo.id !== "recepcion"' class="col-2">
                <plex-select [(ngModel)]="origen" (change)="refreshSelection($event,'origen')" name="origen" label="Origen" [data]="origenEnum"></plex-select>
            </div>
            <div class="col-2">
                <plex-datetime type="date" [(ngModel)]="busqueda.solicitudDesde" (change)="refreshSelection($event,'fechaDesde')" name="solicitudDesde"
                    label="Fecha desde" class="fechas" [required]="true">
                </plex-datetime>
            </div>
            <div class="col-2">
                <plex-datetime type="date" [(ngModel)]="busqueda.solicitudHasta" (change)="refreshSelection($event,'fechaHasta')" name="solicitudHasta"
                    label="Fecha hasta" class="fechas" [required]="true">
                </plex-datetime>
            </div>
            <div class="col-2 labs-contenedor-secundario" *ngIf='modo.id ==="recepcion"'>
                <plex-button title="Iniciar Protocolo" icon="plus" class="align-self-end" type="success" (click)="mostrarFomularioPacienteSinTurno(activeTab)"></plex-button>
            </div>
            <div class="col-2 labs-contenedor-secundario" *ngIf='modo.id !== "recepcion"'>
                <div class="contenedor-bloque-texto line-height mr-2">
                    <small class="text-primary"></small>
                </div>
                <plex-button label="" type="info" [icon]="mostrarMasOpciones ? 'chevron-up' : 'chevron-down'" (click)="mostrarMasOpciones = !mostrarMasOpciones"></plex-button>
            </div>
        </div>
        <!-- FIN FILTROS BASICOS  -->

        <!-- FILTROS AVANZADOS-->
        <ng-container *ngIf="mostrarMasOpciones">
            <div class="row">
                <div *ngIf='modo.id ==="carga"' class="col">
                    <plex-select [(ngModel)]="servicio" name="servicio" (getData)="loadServicios($event)" (change)="refreshSelection($event,'servicio')"
                        label="Servicio" placeholder="Seleccione el servicio" labelField="term" [multiple]="true" [required]="false"
                        idField="term">
                    </plex-select>
                </div>
                <div *ngIf='modo.id !== "carga" && modo.id !== "recepcion"' class="col-3">
                    <plex-select [(ngModel)]="servicio" name="servicio" (getData)="loadServicios($event)" (change)="refreshSelection($event,'servicio')"
                        label="Servicio" placeholder="Seleccione el servicio" labelField="term" [required]="false" idField="term">
                    </plex-select>
                </div>
                <div *ngIf='modo.id !== "recepcion"' class="col-3">
                    <plex-float [(ngModel)]="numProtocoloDesde" (change)="refreshSelection($event,'numProtocoloDesde')" name="numProtocoloDesde"
                        label="N° protocolo desde"></plex-float>
                </div>
                <div *ngIf='modo.id !== "recepcion"' class="col-3">
                    <plex-float [(ngModel)]="numProtocoloHasta" (change)="refreshSelection($event,'numProtocoloHasta')" name="numProtocoloHasta"
                        label="N° protocolo hasta"></plex-float>
                </div>
                <div *ngIf='modo.id !== "recepcion"' class="col-3">
                    <plex-select [(ngModel)]="organizacion" (change)="refreshSelection($event,'organizacion')" name="organizacion" label="Efector Solicitante"
                        (getData)="loadOrganizaciones($event)"></plex-select>
                </div>
                <div *ngIf='modo.id ==="listado"' class="col-3">
                    <plex-select [(ngModel)]="estado" (change)="refreshSelection($event,'estado')" name="estado" label="Estado" [data]="estadosFiltroEnum"></plex-select>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label>Paciente</label>
                    <paciente-buscar (searchStart)="searchStartPaciente()" (searchEnd)="searchEndPaciente($event)" (searchClear)="searchClearPaciente($event)"></paciente-buscar>
                    <div class="scrollPacientes" *ngIf='mostrarListaMpi'>
                        <paciente-listado *ngIf="pacientes && pacientes.length" [pacientes]="pacientes" [autoselect]="false" (selected)="seleccionarPaciente($event)"
                            (hover)="hoverPaciente($event)"></paciente-listado>
                    </div>
                </div>
            </div>
        </ng-container>
        <!-- FIN FILTROS AVANZADOS-->


        <br>
        <hr>

        <!--VISUALIZACIÓN DE PROTOCOLOS CONTROL -->
        <div *ngIf="!protocolos?.length" class="alert alert-default">
            <i class="mdi mdi-emoticon-sad"></i> No hay protocolos que coincidan con los filtros de búsqueda
        </div>

        <!-- <table class="table table-striped table-sm" *ngIf='modo.id !== "recepcion"'>
            <tbody>
                <tr class="labs-listado-item listado-contenedor-secundario" *ngFor="let protocolo of protocolos; let i=index">
                    <td *ngIf='modo.id !== "recepcion"' class="labs-item-numero">

                        <i *ngIf='protocolo.paciente.sexo ==="femenino"' class="mdi mdi-gender-female mdi-36px mdi-rotate-45
                    rosa"></i>
                        <i *ngIf='protocolo.paciente.sexo ==="masculino"' class="mdi mdi-gender-male mdi-36px azul"></i>
                        <h2>{{protocolo.solicitud.registros[0].valor.solicitudPrestacion.numeroProtocolo?.numeroCompleto}}</h2>

                        <br>
                    </td>
                    <td class="contenedor-bloque-texto">
                        <div class="labs-item-texto">
                            <label>|&nbsp;Fecha de toma muestra&nbsp;</label>
                            {{protocolo.ejecucion.fecha |fecha}}
                            <label>&nbsp;|&nbsp;Origen&nbsp;</label>
                            {{protocolo.solicitud.ambitoOrigen}}
                        </div>
                        <div class="labs-item-texto">
                            <label>|&nbsp;Dni Paciente:&nbsp;</label>
                            {{protocolo.paciente.documento}}
                            <label>&nbsp;|&nbsp;Nombre y Apellido:&nbsp;</label>
                            {{protocolo.paciente.nombre}} {{protocolo.paciente.apellido}} 
                            <label>&nbsp;|&nbsp;Fecha de Nacimiento:&nbsp;</label>
                            {{protocolo.paciente.fechaNacimiento |fecha}}
                            <label>&nbsp;|&nbsp;Sexo:&nbsp;</label>
                            {{protocolo.paciente.sexo}}
                        </div>
                    </td>

                    <td class="badge-container">
                        <plex-badge *ngIf="protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre === 'Urgencia'" type="danger" class="ml-2">{{protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre}}</plex-badge>
                        <plex-badge *ngIf="protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre === 'Normal'" type="success" class="ml-2">{{protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre}}</plex-badge>

                        <plex-badge *ngIf="protocolo.estados[protocolo.estados.length -1].tipo === 'ejecucion'" type="warning" class="ml-2">{{protocolo.estados[protocolo.estados.length -1].tipo}}</plex-badge>
                        <plex-badge *ngIf="protocolo.estados[protocolo.estados.length -1].tipo === 'validada'" type="success" class="ml-2">{{protocolo.estados[protocolo.estados.length -1].tipo}}</plex-badge>

                        <plex-button type="primary" size="sm" (click)="verProtocolo(protocolo, i)" class="ml-2">Ver protocolo</plex-button>

                    </td>
                </tr>
            </tbody>
        </table> -->
        <ng-container *ngIf="protocolos.length > 0">
            <table class="table table-striped table-sm" *ngIf='modo.id !== "recepcion"'>
                <thead>
                    <th>Nro.</th>
                    <th>Fecha</th>
                    <th>Entrega</th>
                    <th>DNI</th>
                    <th>Apellidos y Nombres</th>
                    <th>F. Nacimiento</th>
                    <th>Sexo</th>
                    <th>Origen</th>
                    <th>Prioridad</th>
                    <!-- <th>Usuario</th>
                    <th>Fecha Act.</th> -->
                    <th></th>
                    <th></th>
                    <th></th>
                </thead>
                <tbody>
                    <tr *ngFor="let protocolo of protocolos; let i=index">
                        <td>{{protocolo.solicitud.registros[0].valor.solicitudPrestacion.numeroProtocolo?.numeroCompleto}}</td>
                        <td>{{protocolo.solicitud.fecha | fecha}}</td>
                        <td>{{protocolo.ejecucion.fecha | fecha}}</td>
                        <td>{{protocolo.paciente.documento}}</td>
                        <td>{{protocolo.paciente.apellido}} {{protocolo.paciente.nombre}}</td>
                        <td>{{protocolo.paciente.fechaNacimiento | fecha}}</td>
                        <td *ngIf='protocolo.paciente.sexo ==="femenino"'>F</td>
                        <td *ngIf='protocolo.paciente.sexo ==="masculino"'>M</td>
                        <!-- <i *ngIf='protocolo.paciente.sexo ==="femenino"' class="mdi mdi-gender-female mdi-36px mdi-rotate-45
                        rosa"></i>
                            <i *ngIf='protocolo.paciente.sexo ==="masculino"' class="mdi mdi-gender-male mdi-36px azul"></i> -->
                        <td>{{protocolo.solicitud.ambitoOrigen}}</td>
                        <td>
                            <plex-badge *ngIf="protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre === 'Urgencia'" type="danger"
                                class="ml-2">{{protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre}}</plex-badge>
                            <plex-badge *ngIf="protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre === 'Normal'" type="success"
                                class="ml-2">{{protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre}}</plex-badge>
                        </td>
                        <td>
                            <plex-badge *ngIf="protocolo.estados[protocolo.estados.length -1].tipo === 'ejecucion'" type="warning" class="ml-2">{{protocolo.estados[protocolo.estados.length -1].tipo}}</plex-badge>
                            <plex-badge *ngIf="protocolo.estados[protocolo.estados.length -1].tipo === 'validada'" type="success" class="ml-2">{{protocolo.estados[protocolo.estados.length -1].tipo}}</plex-badge>
                        </td>
                        <!-- <td>Usuario</td>
                    <td>Fecha Act.</td> -->
                        <!-- <td></td> -->
                        <td>
                            <plex-button type="success" size="sm" (click)="verProtocolo(protocolo, i)" class="ml-2">
                                <ng-container *ngIf='modo.id === "recepcion"'>Recepcionar
                                </ng-container>
                                <ng-container *ngIf='modo.id === "control"'>Auditar
                                </ng-container>
                                <ng-container *ngIf='modo.id === "carga"'>Cargar
                                </ng-container>
                                <ng-container *ngIf='modo.id ==="validacion"'>Validar
                                </ng-container>
                                <ng-container *ngIf='modo.id === "listado"'>Ver Protocolo
                                </ng-container>
                            </plex-button>
                            <plex-button type="success" size="sm" (click)="verProtocolo(protocolo, i)" class="ml-2">
                                <i class="mdi mdi-file-document"></i>
                            </plex-button>
                        </td>

                    </tr>
                </tbody>
            </table>
        </ng-container>
        <!-- TABLA VISUALIZACION DE RECEPCION -->
        <table *ngIf='protocolos && modo.id ==="recepcion"' class="table table-striped table-sm">
            <thead>
                <th>Fecha de solicitud</th>
                <th>Dni del Paciente</th>
                <th>Nombre y apellido del Paciente</th>
                <th>Operaciones</th>
                <th></th>
                <th></th>
            </thead>
            <tbody>
                <tr *ngFor="let prestacion of protocolos; let i=i ndex">
                    <td>{{prestacion.solicitud.fecha | fecha}}</td>
                    <td>{{prestacion.paciente.documento}}</td>
                    <td>{{prestacion.paciente | paciente}}</td>
                    <td>
                        <plex-button type="success" size="sm" (click)="verProtocolo(prestacion, i)" class="ml-2">Iniciar protocolo</plex-button>
                        <!-- <plex-button type="success" size="sm" (click)="editProtocolo($event)" class="ml-2">
                                <i class="mdi mdi-file-document"></i>
                            </plex-button> -->
                    </td>
                </tr>
            </tbody>
        </table>
    </plex-layout-main>

    <plex-layout-sidebar *ngIf="!showListarProtocolos">
        <protocolo-detalle *ngIf="!showListarProtocolos" [cargarProtocolo]="protocolo" [showProtocoloDetalle]="showProtocoloDetalle"
        [indexProtocolo]='indexProtocolo' [protocolos]="protocolos" [modo]='modo' [seleccionPaciente]='seleccionPaciente' (volverAListaControEmit)='volverLista()'></protocolo-detalle>
    </plex-layout-sidebar>
    <!-- Panel lateral -->

    <!-- footer -->
    <plex-layout-footer>
        <plex-button label="accion clave" type="primary" position="left" label="Crear un nuevo protocolo" (click)="pacienteSinTurno(activeTab)"></plex-button>
        <!-- <plex-button label="Cancelar" type="Cancelar" position="left" (click)="guardarAgendaPanel.cancelar()"></plex-button>
            <plex-button label="Otra accion clave" type="Guardar" position="right" (click)="guardarAgendaPanel.guardarAgenda(agendasSeleccionadas[0])"></plex-button> -->
    </plex-layout-footer>
</plex-layout>

<!-- Switchea a listado practicas -->
<!-- <protocolo-detalle *ngIf="!showListarProtocolos" [cargarProtocolo]="protocolo" [showProtocoloDetalle]="showProtocoloDetalle"
    [indexProtocolo]='indexProtocolo' [protocolos]="protocolos" [modo]='modo' [seleccionPaciente]='seleccionPaciente' (volverAListaControEmit)='volverLista()'></protocolo-detalle> -->