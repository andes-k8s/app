<plex-layout main="{{showProtocoloDetalle ? (recepcionarTurno ? 0 : 2)  : 12}}">
    <plex-layout-main *ngIf='!recepcionarTurno'>
        <!-- ENCABEZADO -->
        <header>
            <div class="clearfix">
                <div class="page-title float-left">
                    <ng-container *ngIf="!showProtocoloDetalle">
                        Laboratorio |
                        <ng-container *ngIf="modo === 'recepcion'">Recepcionar Paciente</ng-container>
                        <ng-container *ngIf="modo === 'control'">Auditoría de Protocolos</ng-container>
                        <ng-container *ngIf="modo === 'carga'">Carga de Resultados</ng-container>
                        <ng-container *ngIf="modo === 'validacion'">Validación de Resultados</ng-container>
                    </ng-container>
                    <ng-container *ngIf="showProtocoloDetalle">
                        Listado
                    </ng-container>
                </div>
                <plex-tabs [activeIndex]="accionIndex" class='float-right' (change)="cambio($event)" *ngIf="!showProtocoloDetalle">
                    <plex-tab label="Recepción"></plex-tab>
                    <plex-tab label="Auditoria"></plex-tab>
                    <plex-tab label="Carga"></plex-tab>
                    <plex-tab label="Validación"></plex-tab>
                </plex-tabs>
            </div>

        </header>
        <!-- FIN ENCABEZADO -->

        <ng-container *ngIf="!showProtocoloDetalle">
            <div class="row contenedor-filtros">
                <div class="col-12" *ngIf='modo === "carga" || modo === "validacion"'>
                    <plex-radio [data]="modoCargaLaboratorioEnum" label="nombre" (change)="diagnosticoPrestacion($event, elemento)" [(ngModel)]="modoCargaLaboratorio"
                        type="horizontal"></plex-radio>
                </div>
                <div class="col-2" *ngIf='modo !== "recepcion"'>
                    <plex-select [(ngModel)]="this.busqueda.area " (change)="refreshSelection($event,'area')" name="area" label="Area" [data]='laboratorioInternoEnum'></plex-select>
                </div>
                <div class="col-2">
                    <plex-select [(ngModel)]="prioridad" (change)="refreshSelection($event,'prioridad')" name="prioridad" label="Prioridad" [data]="prioridadesFiltroEnum"></plex-select>
                </div>
                <div class="col-2">
                    <plex-select [(ngModel)]="origen" (change)="refreshSelection($event,'origen')" name="origen" label="Origen" [data]="origenEnum"></plex-select>
                </div>
                <div class="col-2">
                    <plex-datetime type="date" [(ngModel)]="busqueda.solicitudDesde" (change)="refreshSelection($event,'fechaDesde')" name="solicitudDesde"
                        label="Fecha desde" class="fechas" [required]="true">
                    </plex-datetime>
                </div>
                <div class="col-2">
                    <plex-datetime type="date" [(ngModel)]="busqueda.solicitudHasta" (change)="refreshSelection($event,'fechaHasta')" name="solicitudHasta"
                        label="Fecha hasta" class="fechas" [required]="true">
                    </plex-datetime>
                </div>
                <!-- <div class="col-2 labs-contenedor-secundario" *ngIf='modo ==="recepcion"'>
                    <plex-button title="Iniciar Protocolo" icon="plus" class="align-self-end" type="success" (click)="mostrarFomularioPacienteSinTurno()"></plex-button>
                </div> -->
                <div class="col-2 labs-contenedor-secundario" *ngIf='modo !== "recepcion"'>
                    <div class="contenedor-bloque-texto line-height mr-2">
                        <small class="text-primary"></small>
                    </div>
                    <plex-button label="" type="info" [icon]="mostrarMasOpciones ? 'chevron-up' : 'chevron-down'" (click)="mostrarMasOpciones = !mostrarMasOpciones"></plex-button>
                </div>
            </div>
            <!-- FIN FILTROS BASICOS  -->

            <!-- FILTROS AVANZADOS-->
            <ng-container *ngIf="mostrarMasOpciones">
                <div class="row">
                    <div *ngIf='modo ==="carga"' class="col">
                        <plex-select [(ngModel)]="servicio" name="servicio" (getData)="loadServicios($event)" (change)="refreshSelection($event,'servicio')"
                            label="Servicio" placeholder="Seleccione el servicio" labelField="term" [multiple]="true" [required]="false"
                            idField="term">
                        </plex-select>
                    </div>
                    <div *ngIf='modo !== "carga" && modo !== "recepcion"' class="col-3">
                        <plex-select [(ngModel)]="servicio" name="servicio" (getData)="loadServicios($event)" (change)="refreshSelection($event,'servicio')"
                            label="Servicio" placeholder="Seleccione el servicio" labelField="term" [required]="false" idField="term">
                        </plex-select>
                    </div>
                    <ng-container *ngIf='modo !== "recepcion"'>
                        <div class="col-3">
                            <plex-float [(ngModel)]="busqueda.numProtocoloDesde" (change)="refreshSelection($event,'numProtocoloDesde')" name="numProtocoloDesde"
                                label="N° protocolo desde"></plex-float>
                        </div>
                        <div class="col-3">
                            <plex-float [(ngModel)]="busqueda.numProtocoloHasta" (change)="refreshSelection($event,'numProtocoloHasta')" name="numProtocoloHasta"
                                label="N° protocolo hasta"></plex-float>
                        </div>
                        <div class="col-3">
                            <plex-select [(ngModel)]="organizacion" (change)="refreshSelection($event,'organizacion')" name="organizacion" label="Efector Solicitante"
                                (getData)="loadOrganizaciones($event)"></plex-select>
                        </div>
                    </ng-container>
                </div>
                <div *ngIf='modo ==="listado"' class="col-3">
                    <plex-select [(ngModel)]="estado" (change)="refreshSelection($event,'estado')" name="estado" label="Estado" [data]="estadosFiltroEnum"></plex-select>
                </div>
                <div class="row">
                    <div class="col">
                        <label>Paciente</label>
                        <paciente-buscar (searchStart)="searchStartPaciente()" (searchEnd)="searchEndPaciente($event)" (searchClear)="searchClearPaciente($event)"></paciente-buscar>
                        <div class="scrollPacientes" *ngIf='mostrarListaMpi'>
                            <paciente-listado *ngIf="pacientes && pacientes.length" [pacientes]="pacientes" [autoselect]="false" (selected)="seleccionarPaciente($event)"
                                (hover)="hoverPaciente($event)"></paciente-listado>
                        </div>
                    </div>
                </div>
            </ng-container>
            <!-- FIN FILTROS AVANZADOS-->
        </ng-container>

        <br *ngIf="!showProtocoloDetalle">
        <hr *ngIf="!showProtocoloDetalle">

        <!--VISUALIZACIÓN DE PROTOCOLOS CONTROL -->
        <div *ngIf="!protocolos?.length" class="alert alert-default">
            <i class="mdi mdi-emoticon-sad"></i> No hay protocolos que coincidan con los filtros de búsqueda
        </div>

        <ng-container *ngIf="protocolos.length > 0">
            <table class="table table-striped table-sm">
                <thead>
                    <th *ngIf='modo !== "recepcion"'>Nro.</th>
                    <th>Fecha</th>
                    <ng-container *ngIf="!showProtocoloDetalle">
                        <th>Entrega</th>
                        <th>DNI</th>
                        <th>Apellidos y Nombres</th>
                        <th>F. Nacimiento</th>
                        <th>Sexo</th>
                        <th>Origen</th>
                        <th>Prioridad</th>
                        <th>Estado</th>
                        <th></th>
                        <th></th>
                    </ng-container>
                </thead>
                <tbody>
                    <tr *ngFor="let protocolo of protocolos; let i=index">
                        <td *ngIf='modo !== "recepcion"'>{{protocolo.solicitud.registros[0].valor.solicitudPrestacion.numeroProtocolo?.numeroCompleto}}</td>
                        <td>{{protocolo.solicitud.fecha | fecha}}</td>
                        <!-- <plex-button *ngIf='showProtocoloDetalle' icon="arrow-right-drop-circle-outline" class="float-right mr-2" (click)="editarDatosCabecera()"  
                         > -->
                        <!-- </plex-button> -->
                        <ng-container *ngIf="!showProtocoloDetalle">
                            <td>{{protocolo.ejecucion.fecha | fecha}}</td>
                            <td>{{protocolo.paciente.documento}}</td>
                            <td>{{protocolo.paciente.apellido}} {{protocolo.paciente.nombre}}</td>
                            <td>{{protocolo.paciente.fechaNacimiento | fecha}}</td>
                            <td *ngIf='protocolo.paciente.sexo ==="femenino"'>F</td>
                            <td *ngIf='protocolo.paciente.sexo ==="masculino"'>M</td>
                            <td>{{protocolo.solicitud.ambitoOrigen}}</td>
                            <td>
                                <plex-badge *ngIf="protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre === 'Urgencia'" type="danger"
                                    class="ml-2">{{protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre}}</plex-badge>
                                <plex-badge *ngIf="protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre === 'Normal'" type="success"
                                    class="ml-2">{{protocolo.solicitud.registros[0].valor.solicitudPrestacion.prioridad.nombre}}</plex-badge>
                            </td>
                            <td>
                                <plex-badge *ngIf="protocolo.estados[protocolo.estados.length -1].tipo === 'ejecucion'" type="warning" class="ml-2">{{protocolo.estados[protocolo.estados.length -1].tipo}}</plex-badge>
                                <plex-badge *ngIf="protocolo.estados[protocolo.estados.length -1].tipo === 'validada'" type="success" class="ml-2">{{protocolo.estados[protocolo.estados.length -1].tipo}}</plex-badge>
                            </td>
                            <td>
                                <plex-button type="success" size="sm" (click)="verProtocolo(protocolo, i)" class="ml-2">
                                    <ng-container *ngIf='modo === "recepcion"'>Recepcionar
                                    </ng-container>
                                    <ng-container *ngIf='modo === "control"'>Auditar
                                    </ng-container>
                                    <ng-container *ngIf='modo === "carga"'>Cargar
                                    </ng-container>
                                    <ng-container *ngIf='modo ==="validacion"'>Validar
                                    </ng-container>
                                    <ng-container *ngIf='modo === "listado"'>Ver Protocolo
                                    </ng-container>
                                </plex-button>
                                <plex-button type="success" size="sm" (click)="verProtocolo(protocolo, i)" class="ml-2">
                                    <i class="mdi mdi-file-document"></i>
                                </plex-button>
                            </td>
                        </ng-container>
                    </tr>
                </tbody>
            </table>
        </ng-container>

    </plex-layout-main>

    <plex-layout-sidebar *ngIf="!showListarProtocolos">
        <header>
            <div class="clearfix">
                <div class="page-title float-left">
                    <ng-container *ngIf="showProtocoloDetalle">
                        Laboratorio |
                        <ng-container *ngIf="modo === 'recepcion'">Recepcionar Paciente</ng-container>
                        <ng-container *ngIf="modo === 'control'">Auditoría de Protocolos</ng-container>
                        <ng-container *ngIf="modo === 'carga'">Carga de Resultados</ng-container>
                        <ng-container *ngIf="modo === 'validacion'">Validación de Resultados</ng-container>
                    </ng-container>
                </div>
            </div>
        </header>
        <protocolo-detalle [protocolo]="protocolo" [showProtocoloDetalle]="showProtocoloDetalle" [indexProtocolo]='indexProtocolo'
            [protocolos]="protocolos" [edicionDatosCabecera]='edicionDatosCabecera' [modo]='modo' [seleccionPaciente]='seleccionPaciente'
            (volverAListaControEmit)='volverLista()' (mostrarCuerpoProtocoloEmit)='mostrarBotonesGuardarProtocoloFooter($event)'
            (mostrarCuerpoProtocolo)='mostrarCuerpoProtocolo'></protocolo-detalle>
    </plex-layout-sidebar>

    <plex-layout-footer *ngIf="!showProtocoloDetalle && modo === 'recepcion'" >
        <plex-button label="accion clave" type="primary" position="left" label="Paciente sin Turno" (click)="mostrarFomularioPacienteSinTurno(activeTab)"></plex-button>
    </plex-layout-footer>

    <plex-layout-footer *ngIf="showProtocoloDetalle">
        <plex-button position="left" type="warning" (click)="volverLista()">Volver</plex-button>

        <plex-button *ngIf='modo !=="validacion" && showBotonesGuardar' position="right" class="float-right mr-1" type="success"
            label="Guardar" (click)="protocoloDetalleComponent.guardarSolicitud()"></plex-button>
        <plex-button *ngIf='modo !=="validacion" && showBotonesGuardar' position="right" class="float-right mr-1" type="success"
            label="Guardar + CB" (click)="protocoloDetalleComponent.guardarSolicitud($event)"></plex-button>

        <plex-button *ngIf='modo === "validacion" && showBotonesGuardar' position="right" class="float-right mr-1" type="success"
            label="Validar todos" (click)="protocoloDetalleComponent.guardarSolicitud($event)"></plex-button>
        <plex-button *ngIf='modo === "validacion" && showBotonesGuardar' position="right" class="float-right mr-1" type="success"
            label="Validar pendientes" (click)="protocoloDetalleComponent.guardarSolicitud($event)"></plex-button>

        <plex-button *ngIf='protocoloDetalleComponent && !showBotonesGuardar && (protocoloDetalleComponent.seleccionPaciente || protocoloDetalleComponent.edicionDatosCabecera)'
            position="right" type="success" label="Aceptar" (click)="protocoloDetalleComponent.aceptarEdicionCabecera()"></plex-button>
    </plex-layout-footer>

</plex-layout>

<!-- Switchea a listado practicas -->
<!--     -->