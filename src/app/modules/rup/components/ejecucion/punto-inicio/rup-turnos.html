<ng-container *ngFor="let bloque of actualizarTurnos as turnos">
    <div *ngIf="bloque.descripcion">
        <span *ngIf="!agendaSeleccionada.nominalizada">
            {{bloque.descripcion}} de {{ bloque.horaInicio | date: 'HH:mm'}} a {{ bloque.horaFin | date: 'HH:mm'}}hs
        </span>
        <span class="text-capitalize" *ngIf="agendaSeleccionada.nominalizada">
            {{bloque.descripcion}}
        </span>
    </div>
</ng-container>

<!--Turnos o sobreturnos-->
<!-- {{agendaSeleccionada.sobreturnos | json }} -->
<div class="row" *ngIf="tipo === 'sobreturnos' && agendaSeleccionada?.sobreturnos?.length > 0">
    <div class="col">
        <label class="form-control-label">Sobreturnos de
            <span class="text-capitalize" *ngFor="let tipoPrestacion of agendaSeleccionada.tipoPrestaciones">
                {{ tipoPrestacion.term }}
            </span>
        </label>
    </div>
</div>
<ng-container *ngFor="let bloque of actualizarTurnos as turnos">
    <ng-container *ngFor="let turno of bloque.turnos; let i=index">
        <div *ngIf="turno" class="citas-turno-card"
             [ngClass]="{'sm': turno?.estado == 'disponible' || turno?.estado === 'turnoDoble'}">
            <div>
                <div class="citas-icon"
                     [ngClass]="{'sm': (turno?.estado == 'disponible' || turno?.estado === 'turnoDoble')}">
                    <plex-icon name="clock-outline d-inline-flex bg-primary text-white {{ (turno?.estado == 'disponible' || turno?.estado === 'turnoDoble' ? 'mdi-24px' : '') }}"
                               [ngClass]="{'text-white': agendaSeleccionada == agenda, 'text-primary': agendaSeleccionada !== agenda, 'sm': (turno?.estado == 'disponible' || turno?.estado === 'turnoDoble')}">
                    </plex-icon>
                    <strong>{{ turno.horaInicio | date: 'HH:mm' }}
                        <span *ngIf="turno && turno.nota">
                            <i title="{{turno.nota}}" class="text-warning warning mdi mdi-message"></i>
                        </span>
                    </strong>
                </div>
            </div>
            <div class="ml-1">
                <div>
                    <ng-container *ngIf="turno.paciente?.id">
                        <span>{{ turno.paciente | paciente }}</span>
                        <small class="d-flex">
                            <span>
                                Documento:
                                <span *ngIf="turno.paciente.documento !== ''">
                                    {{ turno.paciente.documento | number }}
                                </span>
                                <span *ngIf="turno.paciente.documento === ''">
                                    Sin documento (temporal)
                                </span>
                            </span>
                            <span class="ml-1"
                                  *ngIf="turno?.paciente?.id && turno.paciente.carpetaEfectores && turno.paciente.carpetaEfectores?.length > 0">
                                Carpeta
                                <span *ngFor="let carpeta of turno.paciente.carpetaEfectores">
                                    {{ carpeta.nroCarpeta }}
                                </span>
                            </span>
                        </small>
                    </ng-container>
                    <plex-badge [ngClass]="{'mr-1': turno.asistencia !== 'noAsistio'}" size="sm"
                                *ngIf="turno.asistencia"
                                type="{{ turno.asistencia === 'asistio' ? 'success' : 'warning' }}">
                        {{ turno.asistencia === 'asistio' ? 'Asistió' : 'No asistió' }}
                        <ng-container *ngIf="turno.horaAsistencia">{{ turno.horaAsistencia | hora }} hs
                        </ng-container>
                    </plex-badge>
                    <plex-button class="mr-1" *ngIf="turno.asistencia === 'noAsistio'" type="warning" size="sm"
                                 (click)="registrarInasistenciaEmit([turno.paciente,agendaSeleccionada, turno.id, 'sacarAsistencia'])"
                                 title="Revertir inasistencia">
                        <i class="mdi mdi-backup-restore"></i>
                    </plex-button>
                    <plex-badge size="sm" type="danger" *ngIf="turno?.estado === 'turnoDoble'">
                        Turno Doble
                    </plex-badge>
                    <plex-badge size="sm" type="danger" *ngIf="turno?.estado === 'suspendido'">
                        Suspendido
                    </plex-badge>

                    <div *ngIf="turno?.confirmatedAt">
                        <br />
                        <plex-badge size="sm" type="default" title="{{turno.confirmatedAt | date: 'medium'}}">
                            Confirmado
                        </plex-badge>
                    </div>

                    <plex-badge *ngIf="turno?.estado == 'disponible'" type="info">{{ turno.estado }}</plex-badge>

                    <ng-container *ngIf="turno.asistencia && turno.estado !== 'suspendido'">

                    </ng-container>
                    <ng-container
                                  *ngIf="turno.prestacion && turno?.prestacion?.estados && turno.asistencia !== 'noAsistio'">
                        <plex-badge type="success"
                                    *ngIf="turno.prestacion.estados[turno.prestacion.estados.length-1].tipo === 'validada'">
                            {{ turno.prestacion.estados[turno.prestacion.estados.length - 1].tipo }}
                        </plex-badge>
                    </ng-container>
                    <ng-container
                                  *ngIf="turno.prestacion && turno?.prestacion?.estados && turno.asistencia !== 'asistio'">
                        <plex-badge type="warning"
                                    *ngIf="turno.prestacion.estados[turno.prestacion.estados.length - 1].tipo === 'ejecucion'">
                            {{ turno.prestacion.estados[turno.prestacion.estados.length - 1].tipo }}
                        </plex-badge>
                    </ng-container>

                </div>
            </div>
            <div *ngIf="turno.prestacion?.turnosPedientes">
                <span title="Turno autocitado sin asignar" class="badge badge-warning">
                    <i class="mdi mdi-message-alert"></i>
                </span>
            </div>
            <div justify="end" *ngIf="turno.tipoPrestacion && turno.paciente?.id">



                <!--Iniciar una prestacion a partir de una solicitud pendiente (es decir una prestacion en estado pendiente) -->
                <!-- <plex-button class="mr-1" size="sm"
                             *ngIf="turno.paciente && turno.estado !== 'suspendido'  && turno.prestacion && turno.prestacion.estados[turno.prestacion.estados.length - 1].tipo === 'pendiente' && servicioPrestacion.tienePermisos(turno.tipoPrestacion, turno.prestacion) && servicioPrestacion.verificarAsistencia(turno)"
                             type="success"
                             (click)="ejecutarPrestacionPendiente(turno.prestacion.id,turno.paciente, turno.tipoPrestacion, turno)"
                             [disabled]="esFutura" title="Iniciar Prestación">
                    <i class="mdi mdi-plus-circle mdi-24px"></i>
                </plex-button> -->

                <!--Una agenda futura muestra en boton deshabilitado -->
                <!-- <plex-button size="sm"
                                 *ngIf="esFutura && turno.paciente && turno.estado !== 'suspendido'  && turno.prestacion && turno.prestacion.estados[turno.prestacion.estados.length - 1].tipo === 'pendiente' && servicioPrestacion.tienePermisos(turno.tipoPrestacion, turno.prestacion) && servicioPrestacion.verificarAsistencia(turno)"
                                 icon="plus-circle" type="disabled btn-sm"
                                 title="Disponible {{diaAgenda(agendaSeleccionada)}}" titlePosition="top">
                    </plex-button> -->

                <!-- Iniciar Prestación -->
                <plex-button class="mr-1" size="sm"
                             *ngIf="agendaSeleccionada.estado !== 'auditada' && turno.estado !== 'suspendido' && turno.paciente && !turno.prestacion && servicioPrestacion.tienePermisos(turno.tipoPrestacion, turno.prestacion) && servicioPrestacion.verificarAsistencia(turno)"
                             type="success"
                             (click)="servicioPrestacion.iniciarPrestacion(turno.paciente, turno.tipoPrestacion, turno)"
                             [disabled]="esFutura" title="Iniciar Prestación">
                    <i class="mdi mdi-plus-circle mdi-24px"></i>
                </plex-button>

                <!-- <plex-button size="sm"
                             *ngIf="esFutura && agendaSeleccionada.estado !== 'auditada' && turno.estado !== 'suspendido' && turno.paciente && !turno.prestacion && servicioPrestacion.verificarAsistencia(turno)"
                             icon="plus-circle" type="disabled btn-sm"
                             title="Disponible {{diaAgenda(agendaSeleccionada)}}" titlePosition="top">
                </plex-button> -->

                <plex-button class="mr-1" size="sm"
                             *ngIf="turno.paciente && turno.estado !== 'suspendido' && turno.prestacion && turno.prestacion.estados[turno.prestacion.estados.length - 1].tipo === 'ejecucion' && servicioPrestacion.tienePermisos(turno.tipoPrestacion, turno.prestacion) && servicioPrestacion.verificarAsistencia(turno)"
                             type="success" (click)="servicioPrestacion.routeTo('ejecucion', turno.prestacion.id)"
                             title="Continuar Registro">
                    <i class="mdi mdi-pencil mdi-24px"></i>

                </plex-button>

                <plex-button class="mr-1" size="sm"
                             *ngIf="turno.paciente && turno.estado !== 'suspendido' && turno.prestacion && turno.prestacion.estados[turno.prestacion.estados.length - 1].tipo === 'validada' && servicioPrestacion.tienePermisos(turno.tipoPrestacion, turno.prestacion)"
                             type="success btn-sm"
                             (click)="servicioPrestacion.routeTo('validacion', turno.prestacion.id)"
                             title="Resumen Prestación">
                    <i class="mdi mdi-eye-settings mdi-24px"></i>
                </plex-button>

                <plex-button class="mr-1" size="sm"
                             *ngIf="!turno.asistencia && !esFutura && agendaSeleccionada.estado !== 'auditada' && turno.estado !== 'suspendido' && turno.paciente && (!turno.prestacion || (turno.prestacion && turno.prestacion.estados[turno.prestacion.estados.length - 1].tipo === 'pendiente') || turno.prestacion && turno.prestacion.estados[turno.prestacion.estados.length - 1].tipo === 'ejecucion')"
                             type="warning btn-sm"
                             (click)="registrarInasistenciaEmit([turno.paciente,agendaSeleccionada, turno.id, 'noAsistio'])"
                             title="Registrar inasistencia">
                    <i class="mdi mdi-account-remove mdi-24px"></i>
                </plex-button>

                <!-- Ver HUDS -->
                <plex-button class="mr-1" size="sm" (click)="servicioPrestacion.routeTo('vista', turno.paciente.id)"
                             type="primary btn-sm" title="Ver HUDS">
                    <i class="icon icon-andes-paciente adi-24px"></i>
                </plex-button>

            </div>
            <div justify="end" *ngIf="agendaSeleccionada.tipoPrestaciones[0].noNominalizada">
                <!--TODO -> revisar cuando se defina el estado final de las agendas no nominalizadas agendaSeleccionada.estado !== 'auditada'-->
                <!-- <plex-button size="sm"
                             *ngIf="!turno.asistencia &&  !esFutura && agendaSeleccionada.estado !== 'auditada' && turno.estado !== 'suspendido' && !turno.prestacion && servicioPrestacion.tienePermisos(turno.tipoPrestacion, turno.prestacion)"
                             icon="plus-circle" type="success btn-sm"
                             (click)="iniciarPrestacionNoNominalizada(turno.tipoPrestacion, turno)">
                </plex-button>

                <plex-button size="sm"
                             *ngIf="!turno.asistencia &&  esFutura && agendaSeleccionada.estado !== 'auditada' && turno.estado !== 'suspendido' && !turno.prestacion"
                             icon="plus-circle" type="disabled btn-sm"
                             title="Disponible {{diaAgenda(agendaSeleccionada)}}" titlePosition="top">
                </plex-button> -->

                <plex-button size="sm"
                             *ngIf="turno.estado !== 'suspendido' && turno.prestacion && turno.prestacion.estados[turno.prestacion.estados.length - 1].tipo === 'ejecucion' && servicioPrestacion.tienePermisos(turno.tipoPrestacion,turno.prestacion)"
                             label="CONTINUAR REGISTRO" type="primary btn-sm"
                             (click)="servicioPrestacion.routeTo('ejecucion', turno.prestacion.id)">
                </plex-button>

                <plex-button size="sm"
                             *ngIf="turno.estado !== 'suspendido' && turno.prestacion && turno.prestacion.estados[turno.prestacion.estados.length - 1].tipo === 'validada' && servicioPrestacion.tienePermisos(turno.tipoPrestacion, turno.prestacion)"
                             label="VER RESUMEN" type="success btn-sm"
                             (click)="servicioPrestacion.routeTo('validacion', turno.prestacion.id)">
                </plex-button>
            </div>


        </div>
    </ng-container>


</ng-container>